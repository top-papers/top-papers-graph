services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # By default we keep the image lightweight.
        # You can enable extras at build time, e.g.:
        #   INSTALL_EXTRAS=temporal,api docker compose build app
        INSTALL_EXTRAS: ${INSTALL_EXTRAS:-}
    image: top-papers-graph:latest
    container_name: top_papers_graph_app
    environment:
      # Wire services by docker-compose DNS names so the stack works out of the box.
      - QDRANT_URL=http://qdrant:6333
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-please_change_me}
      - GROBID_URL=http://grobid:8070

      # If you want to use a local Ollama instance running on your host:
      #   docker compose exec app top-papers-graph run --query "..." --local-model llama3.2
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434}

      - PYTHONUNBUFFERED=1
    volumes:
      # Persist outputs and caches on the host
      - ./runs:/app/runs
      - ./.cache:/app/.cache
      - ./results:/app/results
      # Allow changing domain configs without rebuilding
      - ./configs:/app/configs:ro
      - ./data:/app/data
    extra_hosts:
      # Makes host services (e.g. Ollama) reachable as host.docker.internal on Linux too
      - "host.docker.internal:host-gateway"
    depends_on:
      - qdrant
      - neo4j
      - grobid

  neo4j:
    image: neo4j:5
    container_name: scireason_neo4j
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-please_change_me}
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
    volumes:
      - neo4j_data:/data

  qdrant:
    image: qdrant/qdrant:latest
    container_name: scireason_qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage

  grobid:
    # Official lightweight CPU image (recommended for most cases)
    image: grobid/grobid:0.8.2-crf
    container_name: scireason_grobid
    ports:
      - "8070:8070"
      - "8071:8071"
    environment:
      - JAVA_OPTS=-Xmx4g

  # Опционально: Postgres для Telegram-бота top-papers-bot (если вы его запускаете)
  postgres:
    image: postgres:16
    container_name: scireason_postgres
    environment:
      - POSTGRES_USER=top_papers
      - POSTGRES_PASSWORD=top_papers
      - POSTGRES_DB=top_papers
    ports:
      - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data

volumes:
  neo4j_data:
  qdrant_data:
  pg_data:
